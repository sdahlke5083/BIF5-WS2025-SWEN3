version: '3.8'
name: paperless-swen3

services:
  # REST API service
  paperless.rest:
    image: ${DOCKER_REGISTRY-}paperlessrest
    container_name: paperless-rest
    build:
      context: .
      dockerfile: Paperless.REST/Dockerfile
    ports:
      - "8081:8081"
    volumes:
      - ./.data/Files:/.data/Files:rw
    depends_on:
      - paperless.db
      - paperless.rabbitmq
      - paperless.minio

  # UI service using Blazor
  paperless.ui:
    image: ${DOCKER_REGISTRY-}paperlessui
    container_name: paperless-ui
    build:
      context: . 
      dockerfile: Paperless.UI/Dockerfile
    ports:
      - "80:8080"
      - "443:8081"
    depends_on:
      - paperless.rest

  # OCR Worker service for processing documents
  paperless.worker.ocr:
    image: ${DOCKER_REGISTRY-}paperlessocrworker
    container_name: paperless-ocr-worker
    build:
      context: .
      dockerfile: Paperless.Worker.OCR/Dockerfile
    volumes:
      - ./.data/Files:/.data/Files:rw
    depends_on:
      - paperless.db
      - paperless.rabbitmq

  # Database service using basic PostgreSQL docker image
  paperless.db:
    image: postgres:15
    restart: unless-stopped
    container_name: paperless-db
    environment:
      - POSTGRES_DB=paperless
      - POSTGRES_USER=paperless
      - POSTGRES_PASSWORD=paperless
    volumes:
      - ./.data/paperless-db:/var/lib/postgresql/data:rw
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Adminer service for database management
  paperless.adminer:
    image: adminer:5.4.0
    container_name: paperless-adminer
    restart: unless-stopped
    ports:
      - 9091:8080
    environment:
      - ADMINER_DEFAULT_SERVER=paperless-db
      - ADMINER_DEFAULT_DRIVER=pgsql
      - ADMINER_DESIGN=dracula
    depends_on:
      - paperless.db
  
  # RabbitMQ service for queuing tasks for the workers
  paperless.rabbitmq:
    image: rabbitmq:4.2-rc-management-alpine
    container_name: paperless-rabbitmq
    restart: unless-stopped
    ports:
      - 9093:15672
      - 5672:5672
    environment:
      - RABBITMQ_DEFAULT_USER=paperless
      - RABBITMQ_DEFAULT_PASS=paperless
    volumes:
      - ./.data/paperless-rabbitmq:/var/lib/rabbitmq:rw

  # MinIO object storage used for file storage
  paperless.minio:
    image: minio/minio:latest
    container_name: paperless-minio
    restart: unless-stopped
    ports:
      - 9000:9000    # MinIO API
      - 9090:9001    # MinIO Console
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - ./.data/paperless-minio:/data:rw
    command: server /data --console-address ":9001"




