name: paperless-swen3

services:
  # REST API service
  paperless.rest:
    image: "${DOCKER_REGISTRY}paperlessrest"
    container_name: paperless-rest
    build:
      context: ./Paperless.REST
      dockerfile: Dockerfile
    ports:
      - "8081:8081"
    volumes:
      - ./.data/Files:/.data/Files:rw
    environment:
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_PORT=${RABBITMQ_PORT}
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASS=${RABBITMQ_PASS}
      # Publish to exchange; REST doesn't need a consumer queue but we keep QUEUE for backward compatibility
      - RABBITMQ_EXCHANGE=${RABBITMQ_EXCHANGE}
      - RABBITMQ_EXCHANGE_TYPE=${RABBITMQ_EXCHANGE_TYPE}
      - RABBITMQ_QUEUE=${RABBITMQ_REST_QUEUE}
      - ELASTICSEARCH_HOST=${ELASTICSEARCH_HOST}
      - ELASTICSEARCH_PORT=${ELASTICSEARCH_PORT}
    healthcheck:
        test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
        interval: 10s
        timeout: 5s
        retries: 10
        start_period: 30s
    depends_on:
      - paperless.db
      - paperless.rabbitmq
      - paperless.minio
      - paperless.elasticsearch

  # UI service using Blazor
  paperless.ui:
    image: "${DOCKER_REGISTRY}paperlessui"
    container_name: paperless-ui
    build:
      context: ./Paperless.UI
      dockerfile: Dockerfile
    ports:
      #- "80:8080"
      - "443:8081"
    depends_on:
      - paperless.rest

  # OCR Worker service for processing documents
  paperless.worker.ocr:
    image: "${DOCKER_REGISTRY}paperlessocrworker"
    container_name: paperless-ocr-worker
    build:
      context: ./Paperless.Worker.OCR
      dockerfile: Dockerfile
    volumes:
      - ./.data/paperless-tesseract/tessdata:/tessdata:rw
    environment:
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_PORT=${RABBITMQ_PORT}
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASS=${RABBITMQ_PASS}
      # Consumer queue name for OCR worker
      - RABBITMQ_QUEUE=${RABBITMQ_OCR_QUEUE}
      - RABBITMQ_EXCHANGE=${RABBITMQ_EXCHANGE}
      - RABBITMQ_EXCHANGE_TYPE=${RABBITMQ_EXCHANGE_TYPE}
      - ELASTICSEARCH_HOST=${ELASTICSEARCH_HOST}
      - ELASTICSEARCH_PORT=${ELASTICSEARCH_PORT}
    depends_on:
      - paperless.db
      - paperless.rabbitmq
      - paperless.elasticsearch

  # GenAI Worker service for generating document summaries
  paperless.worker.genai:
    image: "${DOCKER_REGISTRY}paperlessgenaiworker"
    container_name: paperless-genai-worker
    build:
      context: .
      dockerfile: Paperless.Worker.GenAI/Dockerfile
    environment:
      # API-Key und Modell für den GenAI-Provider (Google Gemini)
      - GENAI_API_KEY=${GENAI_API_KEY}
      - GENAI_MODEL=${GENAI_MODEL}
      - GENAI_PROVIDER=GoogleGemini
      # RabbitMQ settings so GenAI worker can connect
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_PORT=${RABBITMQ_PORT}
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASS=${RABBITMQ_PASS}
      # Consumer queue name for GenAI worker
      - RABBITMQ_QUEUE=${RABBITMQ_GENAI_QUEUE}
      - RABBITMQ_EXCHANGE=${RABBITMQ_EXCHANGE}
      - RABBITMQ_EXCHANGE_TYPE=${RABBITMQ_EXCHANGE_TYPE}
      # REST API config
      - REST_API_URL=${REST_API_URL}
      - ELASTICSEARCH_HOST=${ELASTICSEARCH_HOST}
      - ELASTICSEARCH_PORT=${ELASTICSEARCH_PORT}
    depends_on:
      - paperless.db
      - paperless.rabbitmq
      - paperless.elasticsearch

  # --------------------------- Supporting Services ---------------------------
  
  # Database service using basic PostgreSQL docker image
  paperless.db:
    image: postgres:15
    restart: unless-stopped
    container_name: paperless-db
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ./.data/paperless-db:/var/lib/postgresql/data:rw
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Adminer service for database management
  paperless.adminer:
    image: wodby/adminer:5.4
    container_name: paperless-adminer
    restart: unless-stopped
    ports:
      - 9091:80
    environment:
      - ADMINER_DEFAULT_DB_HOST=${ADMINER_DEFAULT_SERVER}
      - ADMINER_DEFAULT_DB_DRIVER=${ADMINER_DEFAULT_DRIVER}
      - ADMINER_DEFAULT_DB_NAME=${POSTGRES_DB}
      - ADMINER_DESIGN=${ADMINER_DESIGN}
    depends_on:
      - paperless.db
  
  # RabbitMQ service for queuing tasks for the workers
  paperless.rabbitmq:
    image: rabbitmq:4.2-rc-management-alpine
    container_name: paperless-rabbitmq
    restart: unless-stopped
    ports:
      - 9093:15672 # management UI
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS}
    volumes:
      - ./.data/paperless-rabbitmq:/var/lib/rabbitmq:rw
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "status"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Elasticsearch for full-text search
  paperless.elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.16.0
    container_name: paperless-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - 9200:9200
    volumes:
      - ./.data/paperless-elasticsearch:/usr/share/elasticsearch/data:rw
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # MinIO object storage used for file storage
  paperless.minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: paperless-minio
    restart: unless-stopped
    ports:
      #- 9000:9000    # MinIO API
      - 9090:9001    # MinIO Console
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - ./.data/paperless-minio:/data:rw
    command: server /data --console-address ":9001"




