@page "/upload"
@using Microsoft.AspNetCore.Components.Forms
@inject Paperless.UI.Services.IUploadsApiClient UploadsApi

<PageTitle>Upload</PageTitle>

<h3>Upload a file</h3>

<InputFile OnChange="OnFileSelected" accept="application/pdf,.pdf"/>
<button class="btn btn-primary mt-2" @onclick="UploadAsync" disabled="@(selectedFile is null || isUploading)">Upload</button>

@if (isUploading)
{
    <p>Uploading...</p>
}
@if (!string.IsNullOrEmpty(status))
{
    <p>@status</p>
}

@code {
    private IBrowserFile? selectedFile;
    private bool isUploading = false;
    private string? status;

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        status = null;

        // Client-side guard
        if (!IsPdf(file))
        {
            selectedFile = null;
            status = "Only PDF files are allowed.";
            return;
        }

        selectedFile = file;
    }

    private static bool IsPdf(IBrowserFile file)
    {
        if (file is null) return false;

        if (!file.Name.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
            return false;

        if (string.IsNullOrWhiteSpace(file.ContentType))
            return true;

        return file.ContentType.Equals("application/pdf", StringComparison.OrdinalIgnoreCase)
               || file.ContentType.Equals("application/x-pdf", StringComparison.OrdinalIgnoreCase);
    }

    private async Task UploadAsync()
    {
        if (selectedFile is null) 
            return;
        try
        {
            isUploading = true;
            var result = await UploadsApi.UploadAsync(selectedFile);
            status = $"OK: accepted={result.accepted}, saved=[{string.Join(", ", result.saved)}]";
        }
        catch (Exception ex)
        {
            status = $"Error: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }
}
